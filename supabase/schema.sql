-- DROP EXISTING TABLES
DROP TABLE IF EXISTS books;
DROP TABLE IF EXISTS categories;

-- CREATE CATEGORIES TABLE
CREATE TABLE categories (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    parent_id BIGINT REFERENCES categories(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- CREATE BOOKS TABLE WITH TAGS
CREATE TABLE books (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT NOT NULL,
    mega_link TEXT NOT NULL,
    cover_image TEXT,
    category_id BIGINT REFERENCES categories(id) ON DELETE CASCADE NOT NULL,
    tags TEXT[] DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- ENABLE RLS
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE books ENABLE ROW LEVEL SECURITY;

-- POLICIES FOR CATEGORIES (Public Access)
CREATE POLICY "Public Select" ON categories FOR SELECT USING (true);
CREATE POLICY "Public Insert" ON categories FOR INSERT WITH CHECK (true);
CREATE POLICY "Public Update" ON categories FOR UPDATE USING (true);
CREATE POLICY "Public Delete" ON categories FOR DELETE USING (true);

-- POLICIES FOR BOOKS (Public Access)
CREATE POLICY "Public Select" ON books FOR SELECT USING (true);
CREATE POLICY "Public Insert" ON books FOR INSERT WITH CHECK (true);
CREATE POLICY "Public Update" ON books FOR UPDATE USING (true);
CREATE POLICY "Public Delete" ON books FOR DELETE USING (true);

